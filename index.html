<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>JPUZ ‚Äî Puzzle cifrado (Create & Play)</title>
  <style>
    :root{
      --bg0:#0b0f10;
      --panel:#11181a;
      --panel2:#0e1416;
      --text:#eaf2f3;
      --muted:#a9b7bb;
      --line:rgba(255,255,255,.10);
      --accent:#7dd3fc;

      --btn:#182125;
      --btn2:#1f2a2f;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;

      --overlay:rgba(0,0,0,.72);
      --overlayLock:rgba(5,6,7,.96);

      --feltA:#0b2f2f;
      --feltB:#072323;
      --feltC:#052020;

      --radius:14px;
      --shadow: 0 12px 40px rgba(0,0,0,.40);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
    }

    body[data-theme="blue"]{
      --accent:#7dd3fc;
      --feltA:#0b2f2f; --feltB:#072323; --feltC:#052020;
    }
    body[data-theme="chalk"]{
      --accent:#a3e635;
      --feltA:#0a1414; --feltB:#071010; --feltC:#050c0c;
    }
    body[data-theme="forest"]{
      --accent:#34d399;
      --feltA:#0a2a16; --feltB:#072012; --feltC:#05180d;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 800px at 10% 10%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(1200px 800px at 90% 20%, rgba(52,211,153,.08), transparent 60%),
                  linear-gradient(180deg, var(--bg0), #070a0b 70%);
      overflow:hidden;
    }

    .topbar{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(20,28,30,.92), rgba(12,16,18,.92));
      backdrop-filter: blur(10px);
      position:relative;
      z-index:5;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      min-width: 220px;
    }
    .badge{
      width:34px;height:34px;border-radius:10px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.05)),
                  linear-gradient(135deg, rgba(125,211,252,.45), rgba(52,211,153,.25));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .brand h1{
      font-size:14px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand .sub{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    .player{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 1;
      justify-content:center;
      min-width: 0;
    }
    .status{
      display:flex;
      flex-direction:column;
      min-width: 180px;
      max-width: 360px;
      overflow:hidden;
    }
    .status .label{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .status .value{
      font-size:14px;
      font-weight:650;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .timer{
      font-family:var(--mono);
      font-size:16px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      background: rgba(0,0,0,.25);
      min-width:110px;
      text-align:center;
    }

    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      min-width: 260px;
    }

    button, .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(31,42,47,.95), rgba(18,26,29,.95));
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      font-size:13px;
      cursor:pointer;
      transition: transform .06s ease, filter .15s ease, border-color .15s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    button:hover{ filter: brightness(1.06); border-color: rgba(255,255,255,.22); }
    button:active{ transform: translateY(1px); }
    button[disabled]{ opacity:.55; cursor:not-allowed; }

    .btn-ghost{
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.12);
    }
    .btn-accent{
      border-color: rgba(125,211,252,.35);
      background: linear-gradient(180deg, rgba(125,211,252,.18), rgba(31,42,47,.90));
    }
    .btn-danger{
      border-color: rgba(239,68,68,.35);
      background: linear-gradient(180deg, rgba(239,68,68,.16), rgba(31,42,47,.90));
    }

    .layout{
      height: calc(100% - 64px);
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:0;
    }

    .sidebar{
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,22,24,.92), rgba(10,14,16,.92));
      overflow:auto;
      padding:14px;
    }
    .tabs{
      display:flex;
      gap:8px;
      margin-bottom:12px;
    }
    .tab{
      flex:1;
      text-align:center;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      cursor:pointer;
      user-select:none;
      font-size:13px;
      color:var(--muted);
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(125,211,252,.35);
      background: rgba(125,211,252,.10);
    }

    .panel{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow);
      margin-bottom:12px;
    }
    .panel h2{
      font-size:13px;
      margin:0 0 10px 0;
      letter-spacing:.2px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    input[type="checkbox"]{ width:auto; }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .hr{
      height:1px;
      background: var(--line);
      margin:12px 0;
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }
    .filebox{
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
    }

    .board{
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(900px 600px at 20% 20%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,255,255,.04), transparent 65%),
        radial-gradient(circle at 50% 30%, rgba(0,0,0,.10), transparent 40%),
        linear-gradient(180deg, var(--feltA), var(--feltB));
    }
    #canvasHost{
      position:absolute;
      inset:0;
      touch-action:none;
      outline:none;
    }
    #targetFrame{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      border-radius: 18px;
      border: 2px dashed rgba(255,255,255,.18);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      pointer-events:none;
      opacity: .9;
    }
    #targetFrame::after{
      content:"Marco gu√≠a";
      position:absolute;
      left:12px;
      top:10px;
      font-size:12px;
      color: rgba(255,255,255,.45);
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      padding:5px 8px;
      border-radius: 999px;
    }

    /* Overlay system */
    #overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10;
      padding:18px;
    }
    #overlay.active{ display:flex; }
    #overlay .backdrop{
      position:absolute;
      inset:0;
      background: var(--overlay);
      backdrop-filter: blur(10px);
    }
    #overlay.lock .backdrop{
      background: var(--overlayLock);
      backdrop-filter:none;
    }
    #overlay .modal{
      position:relative;
      width:min(720px, 100%);
      max-height:min(86vh, 820px);
      overflow:auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(18,26,29,.98), rgba(10,14,16,.98));
      box-shadow: 0 40px 120px rgba(0,0,0,.55);
      padding:14px;
    }
    #overlay .modal h3{
      margin:0 0 8px 0;
      font-size:16px;
      letter-spacing:.2px;
    }
    #overlay .modal .content{
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    #overlay .modal .actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    #overlay img.preview{
      width:100%;
      height:auto;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:block;
    }

    @media (max-width: 900px){
      body{ overflow:auto; }
      .layout{
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .sidebar{
        border-right:none;
        border-bottom:1px solid var(--line);
      }
      .controls{ min-width: 0; }
      .brand{ min-width: 0; }
    }
  </style>
</head>

<body data-theme="blue">
  <div class="topbar">
    <div class="brand">
      <div class="badge" aria-hidden="true"></div>
      <div>
        <h1>JPUZ</h1>
        <p class="sub">Crear / Jugar retos cifrados 100% local</p>
      </div>
    </div>

    <div class="player" aria-live="polite" aria-atomic="true">
      <div class="status">
        <div class="label">Estado</div>
        <div class="value" id="statusText">Listo</div>
      </div>
      <div class="timer" id="timerText" title="Tiempo restante">--:--</div>
    </div>

    <div class="controls">
      <button id="btnBoxTop" class="btn-ghost" title="Box top (B)" disabled>üñºÔ∏è Box top</button>
      <button id="btnPause" class="btn-ghost" title="Pausar/Reanudar (P)" disabled>‚èØÔ∏è Pausa</button>
      <button id="btnTheme" class="btn-ghost" title="Cambiar tema (T)">üé® Tema</button>
      <button id="btnReframe" class="btn-ghost" title="Reencuadrar piezas (R)" disabled>üß≤ Reencuadrar</button>
      <button id="btnFull" class="btn-ghost" title="Pantalla completa" >‚õ∂</button>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="tabs" role="tablist" aria-label="Modo">
        <div class="tab active" id="tabCreate" role="tab" aria-selected="true" tabindex="0">Crear</div>
        <div class="tab" id="tabPlay" role="tab" aria-selected="false" tabindex="0">Jugar</div>
      </div>

      <div id="paneCreate">
        <div class="panel">
          <h2>Crear reto (.jpuz)</h2>

          <div>
            <label for="createImage">Imagen</label>
            <input id="createImage" type="file" accept="image/*" />
            <div class="filebox" id="createImageInfo">Ninguna imagen seleccionada.</div>
          </div>

          <div class="hr"></div>

          <div class="grid2">
            <div>
              <label for="piecesX">Piezas X (2‚Äì30)</label>
              <input id="piecesX" type="number" min="2" max="30" value="8" />
            </div>
            <div>
              <label for="piecesY">Piezas Y (2‚Äì30)</label>
              <input id="piecesY" type="number" min="2" max="30" value="6" />
            </div>
          </div>

          <div class="grid2" style="margin-top:10px;">
            <div>
              <label for="solveSeconds">Tiempo l√≠mite (seg)</label>
              <input id="solveSeconds" type="number" min="10" max="86400" value="300" />
            </div>
            <div>
              <label for="revealSeconds">Reveal al completar (seg)</label>
              <input id="revealSeconds" type="number" min="1" max="60" value="5" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <input id="mystery" type="checkbox" />
            <label for="mystery" style="margin:0;color:var(--text);">Mystery mode (sin box top)</label>
          </div>

          <div style="margin-top:10px;">
            <label for="bgTheme">Tema inicial</label>
            <select id="bgTheme">
              <option value="blue">Azul (felt)</option>
              <option value="chalk">Pizarra</option>
              <option value="forest">Bosque</option>
            </select>
          </div>

          <div class="hr"></div>

          <div class="grid2">
            <div>
              <label for="maxDim">Compresi√≥n: max dimensi√≥n (px)</label>
              <input id="maxDim" type="number" min="256" max="4096" value="1600" />
            </div>
            <div>
              <label for="quality">Calidad JPEG (0.5‚Äì1.0)</label>
              <input id="quality" type="number" min="0.5" max="1.0" step="0.05" value="0.85" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="title">T√≠tulo (opcional)</label>
            <input id="title" type="text" placeholder="Ej: Atardecer en la playa" />
          </div>

          <div style="margin-top:10px;">
            <label for="passwordCreate">Contrase√±a (m√≠n 8)</label>
            <input id="passwordCreate" type="password" minlength="8" placeholder="********" />
          </div>

          <div class="hr"></div>

          <button id="btnGenerate" class="btn-accent">üîê Generar y descargar reto.jpuz</button>
          <div class="hint" style="margin-top:10px;">
            Todo ocurre en tu navegador. No se sube nada a servidor.<br/>
            <span class="small">Privacidad pr√°ctica: tras descifrar, cualquiera podr√≠a capturar pantalla. No hay DRM.</span>
          </div>
        </div>
      </div>

      <div id="panePlay" style="display:none;">
        <div class="panel">
          <h2>Jugar reto (.jpuz)</h2>

          <div>
            <label for="jpuzFile">Archivo .jpuz</label>
            <input id="jpuzFile" type="file" accept=".jpuz,application/json" />
            <div class="filebox" id="jpuzInfo">Ning√∫n reto cargado.</div>
          </div>

          <div style="margin-top:10px;">
            <label for="passwordPlay">Contrase√±a</label>
            <input id="passwordPlay" type="password" placeholder="********" />
          </div>

          <div class="hr"></div>

          <button id="btnStart" class="btn-accent" disabled>‚ñ∂Ô∏è Desbloquear y jugar</button>
          <button id="btnRestart" class="btn-ghost" disabled title="Reiniciar el mismo reto">üîÑ Reiniciar</button>

          <div class="hr"></div>
          <div class="hint">
            Atajos: <span style="font-family:var(--mono)">B</span> box top ¬∑ <span style="font-family:var(--mono)">P</span> pausa ¬∑
            <span style="font-family:var(--mono)">T</span> tema ¬∑ <span style="font-family:var(--mono)">R</span> reencuadrar ¬∑
            <span style="font-family:var(--mono)">Esc</span> cerrar overlays.
          </div>
        </div>

        <div class="panel">
          <h2>Ayuda r√°pida</h2>
          <div class="hint">
            <b>Conexiones bloqueadas:</b> al unir piezas correctamente, ya no se separan.<br/>
            <b>Tiempo agotado:</b> no se muestra la imagen; puedes reiniciar.<br/>
            <b>HTTPS:</b> WebCrypto requiere contexto seguro (GitHub Pages vale).<br/>
            <b>Privacidad pr√°ctica:</b> tras descifrar, no se puede impedir 100% una captura.
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Publicaci√≥n en GitHub Pages</h2>
        <div class="hint">
          Sube este <span style="font-family:var(--mono)">index.html</span> al repo y crea un archivo vac√≠o <span style="font-family:var(--mono)">.nojekyll</span>.
          Activa Pages (branch main / root).
        </div>
      </div>
    </aside>

    <main class="board">
      <div id="canvasHost" tabindex="0" aria-label="Mesa de puzzle"></div>
      <div id="targetFrame" aria-hidden="true"></div>

      <div id="overlay" role="dialog" aria-modal="true" aria-live="assertive">
        <div class="backdrop"></div>
        <div class="modal">
          <h3 id="overlayTitle">T√≠tulo</h3>
          <div class="content" id="overlayContent"></div>
          <div class="actions" id="overlayActions"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Dependencias permitidas: motor jigsaw Headbreaker + Konva -->
  <script defer src="https://cdn.jsdelivr.net/npm/konva@8.4.3/konva.min.js"></script>
  <script defer src="https://flbulgarelli.github.io/headbreaker/js/headbreaker.js"></script>


  <script defer>
  // Guardia: evita ‚ÄúReferenceError‚Äù y da un mensaje claro
  const HB = window.headbreaker;
  if (!HB || !HB.Canvas) {
    alert("No se pudo cargar Headbreaker. Revisa la pesta√±a Network (headbreaker.js) y que est√©s en HTTPS.");
    throw new Error("Headbreaker no carg√≥");
  }
  (() => {
    'use strict';

    // ---------------------------
    // Utilidades
    // ---------------------------
    const $ = (sel, el=document) => el.querySelector(sel);
    const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const nextFrame = () => new Promise(r => requestAnimationFrame(() => r()));

    const enc = new TextEncoder();
    const dec = new TextDecoder();

    function fmtTime(ms){
      ms = Math.max(0, ms);
      const total = Math.ceil(ms / 1000);
      const m = Math.floor(total / 60);
      const s = total % 60;
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    function u8ToB64(u8){
      const chunk = 0x8000;
      let out = '';
      for (let i=0;i<u8.length;i+=chunk){
        out += String.fromCharCode(...u8.subarray(i, i+chunk));
      }
      return btoa(out);
    }

    function b64ToU8(b64){
      const bin = atob(b64);
      const u8 = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
      return u8;
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    function isTypingTarget(t){
      if (!t) return false;
      const tag = (t.tagName || '').toLowerCase();
      return tag === 'input' || tag === 'textarea' || tag === 'select' || t.isContentEditable;
    }

    // ---------------------------
    // Overlay UI
    // ---------------------------
    const overlay = $('#overlay');
    const overlayTitle = $('#overlayTitle');
    const overlayContent = $('#overlayContent');
    const overlayActions = $('#overlayActions');

    function hideOverlay(){
      overlay.classList.remove('active','lock');
      overlayTitle.textContent = '';
      overlayContent.innerHTML = '';
      overlayActions.innerHTML = '';
    }

    function showOverlay({title, html, actions=[], lock=false}){
      overlayTitle.textContent = title || '';
      overlayContent.innerHTML = html || '';
      overlayActions.innerHTML = '';

      actions.forEach(a => {
        const btn = document.createElement('button');
        btn.textContent = a.label;
        btn.className = a.className || 'btn-ghost';
        btn.addEventListener('click', () => a.onClick && a.onClick());
        overlayActions.appendChild(btn);
      });

      overlay.classList.toggle('lock', !!lock);
      overlay.classList.add('active');
    }

    overlay.addEventListener('click', (e) => {
      // click fuera del modal para cerrar solo si no es lock
      if (overlay.classList.contains('lock')) return;
      if (e.target === overlay || e.target.classList.contains('backdrop')) hideOverlay();
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && overlay.classList.contains('active') && !overlay.classList.contains('lock')) {
        hideOverlay();
      }
    });

    // ---------------------------
    // Estado app
    // ---------------------------
    const state = {
      theme: 'blue',
      jpuzObj: null,
      payload: null,
      imgDataUrl: null,

      canvas: null,
      running: false,
      paused: false,
      solved: false,
      timeEndAt: 0,
      remainingMs: 0,
      tickId: null,
    };

    const statusText = $('#statusText');
    const timerText = $('#timerText');

    function setStatus(text){
      statusText.textContent = text;
    }
    function setTimer(ms){
      timerText.textContent = fmtTime(ms);
    }

    function setTheme(theme){
      theme = theme || 'blue';
      document.body.setAttribute('data-theme', theme);
      state.theme = theme;
      $('#bgTheme').value = theme;
    }
    function cycleTheme(){
      const order = ['blue','chalk','forest'];
      const idx = order.indexOf(state.theme);
      setTheme(order[(idx+1) % order.length]);
    }

    // ---------------------------
    // Crypto (PBKDF2 + AES-GCM)
    // ---------------------------
    async function deriveKeyPBKDF2(password, saltU8, iterations){
      const keyMaterial = await crypto.subtle.importKey(
        'raw',
        enc.encode(password),
        {name:'PBKDF2'},
        false,
        ['deriveKey']
      );

      return crypto.subtle.deriveKey(
        {name:'PBKDF2', hash:'SHA-256', salt: saltU8, iterations},
        keyMaterial,
        {name:'AES-GCM', length: 256},
        false,
        ['encrypt','decrypt']
      );
    }

    async function encryptPayload(payloadObj, password, iterations=150000){
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));

      const key = await deriveKeyPBKDF2(password, salt, iterations);
      const pt = enc.encode(JSON.stringify(payloadObj));
      const ctBuf = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, pt);

      return {
        v: 1,
        kdf: 'PBKDF2',
        iter: iterations,
        salt: u8ToB64(salt),
        alg: 'AES-GCM',
        iv: u8ToB64(iv),
        ct: u8ToB64(new Uint8Array(ctBuf))
      };
    }

    async function decryptJpuz(jpuzObj, password){
      if (!jpuzObj || typeof jpuzObj !== 'object') throw new Error('Archivo .jpuz inv√°lido (no es JSON).');
      if (jpuzObj.kdf !== 'PBKDF2') throw new Error('KDF no soportada.');
      if (jpuzObj.alg !== 'AES-GCM') throw new Error('Algoritmo no soportado.');
      if (!jpuzObj.salt || !jpuzObj.iv || !jpuzObj.ct) throw new Error('Faltan campos en el .jpuz.');

      const iterations = Number(jpuzObj.iter) || 150000;
      const salt = b64ToU8(jpuzObj.salt);
      const iv = b64ToU8(jpuzObj.iv);
      const ct = b64ToU8(jpuzObj.ct);

      const key = await deriveKeyPBKDF2(password, salt, iterations);

      let ptBuf;
      try{
        ptBuf = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
      }catch{
        throw new Error('Contrase√±a incorrecta o archivo corrupto (fall√≥ AES-GCM).');
      }

      const json = dec.decode(new Uint8Array(ptBuf));
      let payload;
      try{
        payload = JSON.parse(json);
      }catch{
        throw new Error('Payload descifrado no es JSON v√°lido.');
      }
      return payload;
    }

    // ---------------------------
    // Procesado imagen (resize + crop a ratio piezasX/piezasY + JPEG)
    // ---------------------------
    function loadImageFromURL(url){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('No se pudo cargar la imagen.'));
        img.src = url;
      });
    }

    async function compressAndCropImage(file, {maxDim, quality, targetAspect}){
      const url = URL.createObjectURL(file);
      try{
        const img = await loadImageFromURL(url);

        const scale = Math.min(1, maxDim / Math.max(img.naturalWidth, img.naturalHeight));
        const w = Math.max(1, Math.round(img.naturalWidth * scale));
        const h = Math.max(1, Math.round(img.naturalHeight * scale));

        const tmp = document.createElement('canvas');
        tmp.width = w; tmp.height = h;
        const tctx = tmp.getContext('2d', {alpha:false});
        tctx.imageSmoothingEnabled = true;
        tctx.imageSmoothingQuality = 'high';
        tctx.drawImage(img, 0, 0, w, h);

        // center crop a targetAspect
        let sx=0, sy=0, sw=w, sh=h;
        if (targetAspect && isFinite(targetAspect) && targetAspect > 0){
          const cur = w / h;
          if (cur > targetAspect){
            // demasiado ancho
            sh = h;
            sw = Math.round(h * targetAspect);
            sx = Math.round((w - sw) / 2);
          } else if (cur < targetAspect){
            sw = w;
            sh = Math.round(w / targetAspect);
            sy = Math.round((h - sh) / 2);
          }
        }

        const out = document.createElement('canvas');
        out.width = sw; out.height = sh;
        const octx = out.getContext('2d', {alpha:false});
        octx.imageSmoothingEnabled = true;
        octx.imageSmoothingQuality = 'high';
        octx.drawImage(tmp, sx, sy, sw, sh, 0, 0, sw, sh);

        const blob = await new Promise((resolve, reject) => {
          out.toBlob(b => b ? resolve(b) : reject(new Error('No se pudo codificar JPEG.')), 'image/jpeg', quality);
        });

        const buf = await blob.arrayBuffer();
        return {
          mime: 'image/jpeg',
          bytes: new Uint8Array(buf),
          width: sw,
          height: sh
        };
      } finally {
        URL.revokeObjectURL(url);
      }
    }

    // ---------------------------
    // Headbreaker: puzzle ‚Äúestricto‚Äù (solo vecinos correctos)
    // ---------------------------
    function makeGridMetadata(px, py){
      const arr = [];
      for (let row=0; row<py; row++){
        for (let col=0; col<px; col++){
          arr.push({ row, col });
        }
      }
      return arr;
    }

    function updateTargetFrame(piecesX, piecesY, pieceSize){
      const frame = $('#targetFrame');
      frame.style.width = `${Math.round(pieceSize * piecesX)}px`;
      frame.style.height = `${Math.round(pieceSize * piecesY)}px`;
    }

    function clearPuzzle(){
      state.running = false;
      state.paused = false;
      state.solved = false;

      stopTimer();

      if (state.canvas){
        try{ state.canvas.clear(); }catch{}
        state.canvas = null;
      }
      $('#canvasHost').replaceChildren();
      $('#btnBoxTop').disabled = true;
      $('#btnPause').disabled = true;
      $('#btnReframe').disabled = true;
      $('#btnRestart').disabled = !state.payload;
    }

    function boardSize(){
      const board = document.querySelector('.board');
      const r = board.getBoundingClientRect();
      return { w: Math.floor(r.width), h: Math.floor(r.height) };
    }

    async function startPuzzleFromPayload(payload){
      clearPuzzle();

      // aplicar tema inicial del reto
      if (payload.bgTheme) setTheme(payload.bgTheme);

      // validar payload m√≠nimo
      const piecesX = Number(payload.piecesX);
      const piecesY = Number(payload.piecesY);
      const solveSeconds = Number(payload.solveSeconds);
      const revealSeconds = Number(payload.revealSeconds);
      const mystery = !!payload.mystery;

      if (!(piecesX>=2 && piecesX<=30 && piecesY>=2 && piecesY<=30)) throw new Error('Piezas X/Y inv√°lidas.');
      if (!(solveSeconds>0)) throw new Error('solveSeconds inv√°lido.');
      if (!(revealSeconds>0)) throw new Error('revealSeconds inv√°lido.');
      if (!payload.mime || !payload.img) throw new Error('Imagen inv√°lida en payload.');

      state.payload = payload;
      state.imgDataUrl = `data:${payload.mime};base64,${payload.img}`;

      // cargar imagen
      const img = await loadImageFromURL(state.imgDataUrl);

      const {w, h} = boardSize();

      // frame ocupa ~55-60% del tablero para dejar ‚Äúmesa‚Äù alrededor
      const maxFrameW = Math.max(240, w * 0.58);
      const maxFrameH = Math.max(220, h * 0.62);
      const pieceSize = clamp(Math.floor(Math.min(maxFrameW / piecesX, maxFrameH / piecesY)), 22, 140);

      updateTargetFrame(piecesX, piecesY, pieceSize);

      const proximity = clamp(Math.round(pieceSize * 0.16), 10, 28);
      const borderFill = clamp(Math.round(pieceSize * 0.10), 3, 16);
      const strokeWidth = clamp(pieceSize * 0.028, 0.8, 2.4);

      // crear canvas Headbreaker
      const canvas = new HB.Canvas('canvasHost', {
        width: w,
        height: h,
        pieceSize: pieceSize,
        proximity,
        borderFill,
        strokeWidth,
        strokeColor: 'rgba(0,0,0,.32)',
        lineSoftness: 0.22,
        image: img,
        fixed: true,
        preventOffstageDrag: true,
        maxPiecesCount: {x: piecesX, y: piecesY},
        outline: new HB.outline.Rounded()
      });

      // Alinear imagen al puzzle (como el ratio ya se croppea en creaci√≥n, encaja)
      canvas.adjustImagesToPuzzleWidth();

      // Piezas con inserts aleatorios m√°s ‚Äúorg√°nicos‚Äù
      canvas.autogenerate({
        horizontalPiecesCount: piecesX,
        verticalPiecesCount: piecesY,
        insertsGenerator: HB.generators.random,
        metadata: makeGridMetadata(piecesX, piecesY)
      });

      // üîí Requisito clave: SOLO permitir conexi√≥n con vecinos correctos (row/col)
      // Horizontal: misma fila, col dif = 1
      canvas.puzzle.attachHorizontalConnectionRequirement((one, other) => {
        return one.metadata.row === other.metadata.row && Math.abs(one.metadata.col - other.metadata.col) === 1;
      });
      // Vertical: misma col, row dif = 1
      canvas.puzzle.attachVerticalConnectionRequirement((one, other) => {
        return one.metadata.col === other.metadata.col && Math.abs(one.metadata.row - other.metadata.row) === 1;
      });

      // Mezclar en ‚Äúmesa‚Äù amplia
      canvas.shuffleGrid(0.95);

      // Bloquear conexiones: una vez unidas, no se separan al arrastrar
      canvas.puzzle.forceConnectionWhileDragging();

      // Validaci√≥n de ‚Äúsolved‚Äù: conectadas + posiciones relativas correctas
      canvas.attachSolvedValidator();

      canvas.onValid(() => {
        if (!state.running || state.solved) return;
        onSolved(revealSeconds);
      });

      canvas.draw();

      state.canvas = canvas;
      state.running = true;
      state.paused = false;
      state.solved = false;

      // UI
      $('#btnPause').disabled = false;
      $('#btnReframe').disabled = false;
      $('#btnRestart').disabled = false;
      $('#btnBoxTop').disabled = mystery; // si mystery => deshabilitar
      setStatus('En juego');
      startTimer(solveSeconds * 1000);
    }

    // ---------------------------
    // Timer / estados
    // ---------------------------
    function stopTimer(){
      if (state.tickId){
        clearInterval(state.tickId);
        state.tickId = null;
      }
      state.timeEndAt = 0;
    }

    function startTimer(ms){
      stopTimer();
      state.remainingMs = ms;
      state.timeEndAt = Date.now() + ms;
      setTimer(ms);

      state.tickId = setInterval(() => {
        if (!state.running || state.paused || state.solved) return;

        const remain = state.timeEndAt - Date.now();
        state.remainingMs = Math.max(0, remain);
        setTimer(state.remainingMs);

        if (state.remainingMs <= 0){
          onTimeUp();
        }
      }, 200);
    }

    function pauseGame(){
      if (!state.running || state.paused || state.solved) return;
      state.paused = true;
      // congelar tiempo
      state.remainingMs = Math.max(0, state.timeEndAt - Date.now());
      setTimer(state.remainingMs);
      setStatus('Pausado');

      showOverlay({
        title:'Pausado',
        html:`<div class="hint">El tiempo est√° detenido. Pulsa <b>P</b> o ‚ÄúReanudar‚Äù.</div>`,
        actions:[
          {label:'Reanudar', className:'btn-accent', onClick: () => { hideOverlay(); resumeGame(); }},
        ],
        lock:false
      });
    }

    function resumeGame(){
      if (!state.running || !state.paused || state.solved) return;
      state.paused = false;
      state.timeEndAt = Date.now() + state.remainingMs;
      setStatus('En juego');
    }

    function onTimeUp(){
      if (!state.running || state.solved) return;
      state.running = false;
      stopTimer();
      setTimer(0);
      setStatus('Tiempo agotado');

      showOverlay({
        title:'‚è≥ Tiempo agotado',
        html:`<div class="hint">No se muestra la imagen. Puedes reiniciar el reto.</div>`,
        actions:[
          {label:'Reiniciar', className:'btn-accent', onClick: () => { hideOverlay(); restartGame(); }},
          {label:'Cerrar', className:'btn-ghost', onClick: () => { /* lock overlay: no-op */ }},
        ],
        lock:true
      });
    }

    async function onSolved(revealSeconds){
      state.solved = true;
      state.running = false;
      stopTimer();
      setStatus('Resuelto');
      setTimer(state.remainingMs);

      // reveal overlay (con imagen completa) durante revealSeconds
      let left = Math.max(1, Math.round(revealSeconds));
      showOverlay({
        title:'‚úÖ ¬°Puzzle resuelto!',
        html:`<div class="hint">Revelando imagen completa durante <b id="revLeft">${left}</b> s‚Ä¶</div>
              <div style="margin-top:10px;"><img class="preview" alt="Imagen revelada" src="${state.imgDataUrl}"></div>`,
        actions:[],
        lock:true
      });

      const revEl = () => $('#revLeft');
      for (let i=0; i<left; i++){
        await sleep(1000);
        const el = revEl();
        if (!el) break;
        el.textContent = String(Math.max(0, left - i - 1));
      }

      // fin: ocultar imagen, mostrar ‚ÄúFin‚Äù
      showOverlay({
        title:'üèÅ Fin',
        html:`<div class="hint">El reveal termin√≥. Para jugar otra vez, reinicia.</div>`,
        actions:[
          {label:'Reiniciar', className:'btn-accent', onClick: () => { hideOverlay(); restartGame(); }},
        ],
        lock:true
      });
    }

    function restartGame(){
      if (!state.payload) return;
      startPuzzleFromPayload(state.payload).catch(err => showError(err));
    }

    // ---------------------------
    // Errores
    // ---------------------------
    function showError(err){
      const msg = (err && err.message) ? err.message : String(err || 'Error desconocido');
      console.error(err);
      showOverlay({
        title:'Error',
        html:`<div class="hint">${msg}</div>`,
        actions:[{label:'Cerrar', className:'btn-accent', onClick: () => hideOverlay()}],
        lock:false
      });
      setStatus('Error');
    }

    // ---------------------------
    // UI: tabs
    // ---------------------------
    function setTab(which){
      const create = which === 'create';
      $('#tabCreate').classList.toggle('active', create);
      $('#tabPlay').classList.toggle('active', !create);
      $('#tabCreate').setAttribute('aria-selected', String(create));
      $('#tabPlay').setAttribute('aria-selected', String(!create));
      $('#paneCreate').style.display = create ? '' : 'none';
      $('#panePlay').style.display = create ? 'none' : '';
    }

    $('#tabCreate').addEventListener('click', () => setTab('create'));
    $('#tabPlay').addEventListener('click', () => setTab('play'));

    // ---------------------------
    // UI: botones topbar
    // ---------------------------
    $('#btnTheme').addEventListener('click', () => cycleTheme());

    $('#btnReframe').addEventListener('click', () => {
      try{
        if (state.canvas){
          state.canvas.reframeWithinDimensions();
          state.canvas.redraw();
        }
      }catch(err){ showError(err); }
    });

    $('#btnPause').addEventListener('click', () => {
      if (!state.running || state.solved) return;
      if (state.paused) { hideOverlay(); resumeGame(); }
      else pauseGame();
    });

    $('#btnBoxTop').addEventListener('click', () => {
      if (!state.payload) return;
      if (state.payload.mystery) return; // deber√≠a estar disabled
      showOverlay({
        title:'üñºÔ∏è Box top',
        html:`<div class="hint">Ayuda visual. Atajo: <b>B</b>. (Recuerda: esto no es DRM; se puede capturar pantalla.)</div>
              <div style="margin-top:10px;"><img class="preview" alt="Box top" src="${state.imgDataUrl}"></div>`,
        actions:[{label:'Cerrar', className:'btn-accent', onClick: () => hideOverlay()}],
        lock:false
      });
    });

    $('#btnFull').addEventListener('click', async () => {
      try{
        if (!document.fullscreenElement){
          await document.documentElement.requestFullscreen();
        } else {
          await document.exitFullscreen();
        }
      }catch{}
    });

    // ---------------------------
    // Atajos teclado
    // ---------------------------
    window.addEventListener('keydown', (e) => {
      if (isTypingTarget(e.target)) return;
      const k = (e.key || '').toLowerCase();
      if (k === 't') cycleTheme();
      if (k === 'r') $('#btnReframe').click();
      if (k === 'p') $('#btnPause').click();
      if (k === 'b') $('#btnBoxTop').click();
    });

    // ---------------------------
    // Crear reto
    // ---------------------------
    const createImage = $('#createImage');
    const createImageInfo = $('#createImageInfo');

    createImage.addEventListener('change', () => {
      const f = createImage.files && createImage.files[0];
      if (!f){
        createImageInfo.textContent = 'Ninguna imagen seleccionada.';
        return;
      }
      createImageInfo.textContent = `${f.name} ¬∑ ${(f.size/1024/1024).toFixed(2)} MB`;
    });

    $('#btnGenerate').addEventListener('click', async () => {
      try{
        const f = createImage.files && createImage.files[0];
        if (!f) throw new Error('Selecciona una imagen.');

        const piecesX = clamp(parseInt($('#piecesX').value,10)||0, 2, 30);
        const piecesY = clamp(parseInt($('#piecesY').value,10)||0, 2, 30);
        const solveSeconds = clamp(parseInt($('#solveSeconds').value,10)||0, 10, 86400);
        const revealSeconds = clamp(parseInt($('#revealSeconds').value,10)||0, 1, 60);
        const mystery = !!$('#mystery').checked;
        const bgTheme = $('#bgTheme').value || 'blue';
        const maxDim = clamp(parseInt($('#maxDim').value,10)||1600, 256, 4096);
        const quality = clamp(parseFloat($('#quality').value)||0.85, 0.5, 1.0);
        const title = ($('#title').value || '').trim();
        const password = $('#passwordCreate').value || '';

        if (password.length < 8) throw new Error('La contrase√±a debe tener m√≠nimo 8 caracteres.');

        setTheme(bgTheme);

        showOverlay({
          title:'Procesando‚Ä¶',
          html:`<div class="hint">Redimensionando, recortando al ratio del puzzle, comprimiendo y cifrando localmente‚Ä¶</div>`,
          actions:[],
          lock:true
        });

        await nextFrame(); // dejar pintar overlay

        // crop a ratio del puzzle para que box top/reveal coincidan con piezas
        const targetAspect = piecesX / piecesY;

        const img = await compressAndCropImage(f, {maxDim, quality, targetAspect});
        await nextFrame();

        const payload = {
          mime: img.mime,
          img: u8ToB64(img.bytes),
          piecesX, piecesY,
          solveSeconds,
          revealSeconds,
          mystery,
          bgTheme,
          createdAt: new Date().toISOString(),
          title: title || undefined
        };

        const jpuz = await encryptPayload(payload, password, 150000);
        const text = JSON.stringify(jpuz, null, 2);

        hideOverlay();
        downloadText('reto.jpuz', text);

        showOverlay({
          title:'‚úÖ Reto generado',
          html:`<div class="hint">
                  Se descarg√≥ <b>reto.jpuz</b>.<br/>
                  Comparte el archivo y la contrase√±a por separado.
                </div>`,
          actions:[{label:'Cerrar', className:'btn-accent', onClick: () => hideOverlay()}],
          lock:false
        });

      }catch(err){
        hideOverlay();
        showError(err);
      }
    });

    // ---------------------------
    // Jugar reto
    // ---------------------------
    const jpuzFile = $('#jpuzFile');
    const jpuzInfo = $('#jpuzInfo');
    const btnStart = $('#btnStart');

    jpuzFile.addEventListener('change', async () => {
      try{
        const f = jpuzFile.files && jpuzFile.files[0];
        state.jpuzObj = null;
        state.payload = null;
        state.imgDataUrl = null;
        clearPuzzle();
        setTimer(0);
        setStatus('Listo');

        if (!f){
          jpuzInfo.textContent = 'Ning√∫n reto cargado.';
          btnStart.disabled = true;
          return;
        }

        const text = await f.text();
        let obj;
        try{ obj = JSON.parse(text); }catch{ throw new Error('El archivo .jpuz no es JSON v√°lido.'); }

        state.jpuzObj = obj;
        jpuzInfo.textContent = `${f.name} ¬∑ ${(f.size/1024).toFixed(1)} KB ¬∑ v=${obj.v ?? '?'}`;
        btnStart.disabled = false;

      }catch(err){
        showError(err);
      }
    });

    btnStart.addEventListener('click', async () => {
      try{
        if (!state.jpuzObj) throw new Error('Carga un archivo .jpuz primero.');
        const pwd = $('#passwordPlay').value || '';
        if (!pwd) throw new Error('Escribe la contrase√±a.');
        showOverlay({title:'Descifrando‚Ä¶', html:`<div class="hint">Descifrando localmente (PBKDF2 + AES-GCM)‚Ä¶</div>`, actions:[], lock:true});
        await nextFrame();

        const payload = await decryptJpuz(state.jpuzObj, pwd);

        hideOverlay();
        await startPuzzleFromPayload(payload);

      }catch(err){
        hideOverlay();
        showError(err);
      }
    });

    $('#btnRestart').addEventListener('click', () => restartGame());

    // ---------------------------
    // Resize: ajustar canvas y marco gu√≠a
    // ---------------------------
    window.addEventListener('resize', () => {
      if (!state.canvas || !state.payload) return;
      try{
        const {w, h} = boardSize();
        state.canvas.resize(w, h);
        state.canvas.redraw();
        // (No recalculamos pieceSize en caliente; para eso, reiniciar.)
      }catch{}
    });

    // init
    setTheme('blue');
    setTimer(0);
    setStatus('Listo');

  })();
  </script>
</body>
</html>


